# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

mulle-template is a POSIX shell-based template processing tool that generates files from templates by substituting environment variables. It uses `<|VARIABLE|>` syntax and sed for text manipulation.

## Essential Commands

### Build and Test

``` bash
# Run all tests
./test/run-test

# Run specific test directly (don't use mulle-sde test run)
cd test/10-copy-file && ./run-test

# Run tests with different shells
./test/run-test --bash
./test/run-test --zsh
```

## Architecture Overview

### Core Components
1. **Entry Point**: `mulle-template` - Main script that routes commands
2. **Template Engine**: `src/mulle-template-generate.sh` - Core sed-based substitution logic
3. **Commands**: `generate`, `csed`, `fsed`, `list`, `environment`

### Template Processing Pipeline
```
Template → Variable Discovery → Sed Generation → Content Processing → Output
```

### Key Functions in mulle-template-generate.sh
- `mulle_template_generate_write()` - Main file generation logic
- `mulle_template_generate_csed()` - Content substitution expressions
- `mulle_template_generate_fsed()` - Filename transformation expressions
- `mulle_template_list_environment()` - Variable discovery and filtering

## Development Rules

### Critical Constraints
- **NEVER** touch files in `cmake/reflect/` or `cmake/share/` (generated by mulle-sde)
- Always use `mulle-sde craft` for building, never run cmake directly
- Tests must output using `mulle_printf` (no assertions) and match `.stdout` files exactly

### Code Style (from ~/.kilocode/rules/styleguide.md)
- 3-space indentation
- Allman braces
- Aligned declarations
- C89 variable rules
- One variable per line

### Testing Requirements
- Tests live in `test/` subdirectories
- Each test has a `run-test` executable script
- Expected output must match corresponding `.stdout` file
- No random data (pointers, dates, PIDs) in test output

## Template Syntax

- Basic substitution: `<|VARIABLE|>`
- Default values: `<|VARIABLE:-default|>`
- Customizable delimiters via `--opener` and `--closer` flags
- Special variables: DATE, TIME, YEAR (auto-generated)

## Common Development Tasks

### Adding New Template Variables
1. Update variable filtering in `mulle_template_list_environment()`
2. Consider if variable should be excluded from "boring" filter
3. Test with both `csed` and `fsed` commands

### Modifying Sed Generation
1. Core logic is in `mulle_template_generate_csed()` and `mulle_template_generate_fsed()`
2. Handle special character escaping properly
3. Test with edge cases (quotes, backslashes, newlines)

### Adding New Commands
1. Add command handler in main `mulle-template` script
2. Follow existing pattern for option parsing and validation
3. Ensure proper error handling and exit codes

## Important Files
- `mulle-template` - Main executable (command routing)
- `src/mulle-template-generate.sh` - Core template processing engine
- `test/run-test` - Test runner script
- `CMakeLists.txt` - Installation configuration (minimal)